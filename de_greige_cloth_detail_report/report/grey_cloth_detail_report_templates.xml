<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="report_grey_cloth_detail_document">
        <t t-call="web.html_container">
        <t t-foreach="docs" t-as="doc">
            <t t-call="web.external_layout">
                <div class="page">
                  <div class="row">
                    <div class="col-8" style="text-align:right;">
                      <strong style="font-size: 26px; font-style: italic;"><strong>Grey Cloth Details</strong></strong>
                    </div>
                    <!--<p style="text-align:center;"></p>-->
                  </div>

                  <div class="row">
                    <table style="width:50%;">
                      <tr>
                        <td><strong>Party Name:</strong></td>
                        <td style="font-size:18px;"><span t-esc="doc.partner_id.name"/></td>
                      </tr>
                    </table>
                  </div>
                  <div class="row">
                    <table style="border: 1px solid black; width:100%;">
                      <thead>
                        <tr>
                          <th style="border: 1px solid black; padding: 5px;">Date</th>
                          <th style="border: 1px solid black; padding: 5px;">Lot No.</th>
                          <th style="border: 1px solid black; padding: 5px;">Quality</th>
                          <th style="border: 1px solid black; padding: 5px;">Mtrs</th>
                        </tr>
                      </thead>
                      <tbody>
                        <t t-set="sum_lot_name" t-value="[]"/>
                        <t t-set="tot_gre_rec" t-value="0"/>
                        <t t-set="tot_gre_used" t-value="0"/>
                        <t t-set="remaining_greige" t-value="0"/>
                        <t t-foreach="doc.invoice_line_ids" t-as="invline">
                          <t t-if="sum_lot_name!=invline.package_id.x_lot_id.name">
                            <t t-foreach="request.env['mrp.production'].search([('lot_producing_id.name','=', invline.package_id.x_lot_id.name), ('product_id.categ_id','=', 237), ('state','=', 'done')])" t-as="mo">
                              <t t-foreach="mo.move_raw_ids" t-as="move">
                                <t t-set="tot_gre_used" t-value="tot_gre_used+move.quantity_done"/>
                              </t>
                            </t>
                            <!--<t t-esc="invline.package_id.x_lot_id.name"/>-->
                            <t t-foreach="request.env['stock.move.line'].sudo().search([('lot_id.name','=', invline.package_id.x_lot_id.name), ('product_id.categ_id','=', 236), ('location_dest_id','=', 20)])" t-as="gre_rec">
                              <tr>
                                <td style="padding: 5px;">
                                    <t t-esc="gre_rec.date.strftime('%d-%m-%Y')"/>
                                </td>
                                <td style="padding: 5px;">
                                  <t t-esc="gre_rec.lot_id.name"/>
                                </td>
                                <td style="padding: 5px;">
                                  <t t-esc="gre_rec.lot_id.cloth_desc"/>
                                </td>
                                <td style="padding: 5px;">
                                  <t t-esc="'{0:,.2f}'.format(gre_rec.qty_done)"/>
                                  <t t-set="tot_gre_rec" t-value="tot_gre_rec+gre_rec.qty_done"/>
                                </td>

                              </tr>

                            </t>
                            </t>
                          <t t-set="sum_lot_name" t-value="invline.package_id.x_lot_id.name"/>
                        </t>
                        <tr style="border-top:1px solid black;">
                        <td colspan="3" style="padding: 5px;">Total Greige Received</td>
                        <td style="padding: 5px;"><t t-esc="'{0:,.2f}'.format(tot_gre_rec)"/></td>
                      </tr>
                      <tr style="">
                        <td colspan="3" style="padding: 5px;">Total Greige Used:</td>
                        <td style="padding: 5px;"><t t-esc="'{0:,.2f}'.format(tot_gre_used)"/></td>
                      </tr>
                      <tr style="border-top:1px solid black;">
                        <td colspan="3" style="padding: 5px;">Remaining Greige:</td>
                        <td style="padding: 5px;">
                          <t t-set="remaining_greige" t-value="remaining_greige + tot_gre_rec - tot_gre_used"/>
                          <t t-esc="'{0:,.2f}'.format(remaining_greige)"/></td>
                      </tr>
                      </tbody>
                    </table>

                  </div>
                </div>
            </t>
        </t>
    </t>
    </template>
</odoo>