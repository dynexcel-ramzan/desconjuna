<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="report_process_bill_unfix_document">
        <t t-call="web.html_container">
        <t t-foreach="docs" t-as="doc">
            <t t-call="web.external_layout">
                <div class="page">
                    <div class="row">
                      <div class="col-9" style="text-align:center; font-size:28px; font-style: italic;">
                        <strong style="padding-left:150px;">PROCESSING BILL</strong>
                      </div>
                      <div class="col-3" style="font-size:17px; font-style: italic;">
                        <strong>(Original Bill)</strong>
                      </div>
                    </div>
                    <div class="row" style="margin-top:5px;">
                      <div class="col-8" style="font-size:18px;">
                        <table>
                          <tr>
                            <th>Customer:</th>
                            <td><span t-field="doc.partner_id"/></td>
                          </tr>
                          <tr>
                            <th>Party PO:</th>
                            <td>
                              <t t-foreach="request.env['sale.order'].search([('name','=', doc.invoice_origin)])" t-as="sale_order">
                                <p class="m-0" t-field="sale_order.party_po"/>
                              </t>
                            </td>
                          </tr>
                          <tr>
                            <th>Reference:</th>
                            <td><p class="m-0" t-field="doc.narration"/></td>
                          </tr>
                        </table>
                      </div>
                      <div class="col-4">
                        <table>
                          <tr>
                            <th>Bill No.</th>
                            <td t-if="doc.state == 'posted' or doc.state == 'approval'"><span t-field="doc.name"/></td>
                            <td t-if="doc.state == 'draft'">Draft (<span t-field="doc.id"/>)</td>
                          </tr>
                          <tr>
                            <th>Date:</th>
                            <td><span t-field="doc.invoice_date" t-options="{'format': 'dd/MM/yyyy'}"/></td>
                          </tr>
                          <tr>
                            <th>Sale Order:</th>
                            <td><p class="m-0" t-field="doc.invoice_origin"/></td>
                          </tr>

                        </table>
                      </div>
                    </div>
                    <t t-set="sum_fresh_qty" t-value="0"/>
                    <t t-set="sum_bgrade_qty" t-value="0"/>
                    <t t-set="sum_cgrade_qty" t-value="0"/>
                    <t t-set="sum_tot_invoice_qty" t-value="0"/>
                    <t t-set="table_index" t-value="0"/>
                    <div class="row" style="margin-top:10px;">
                      <table cellspacing="0" cellpadding="0" class="sm" style="width:100%;">
                        <thead>
                          <tr style="border:1px solid black;">
                            <th style="width:37%; padding: 4px; text-align: center; border-right: 1px solid black;">Description</th>
                            <th style="width:10%; padding: 4px; text-align: center; border-right: 1px solid black;">Quantity</th>
                            <th style="width:10%; padding: 4px; text-align: center; border-right: 1px solid black;">Rate<span style="font-size: 10px;">/mtr</span></th>
                            <th style="width:10%; padding: 4px; text-align: center; border-right: 1px solid black;">Amount</th>
                          </tr>
                        </thead>
                        <tbody style="border:1px solid black;">
                          <t t-set="index" t-value="1"/>
                          <t t-set="p_name" t-value="0"/>
                          <t t-set="pr_name" t-value="0"/>
                          <t t-set="prd_name" t-value="0"/>
                          <t t-set="prd_width" t-value="0"/>
                          <t t-set="sum_product_name" t-value="[]"/>
                          <t t-set="same_packing_type" t-value="0"/>
                          <t t-set="tag_seq" t-value="0"/>
                          <t t-set="tag_sequence" t-value="request.env['account.analytic.tag'].sudo().search([], order='sequence asc')"/>
                          <t t-foreach="tag_sequence" t-as="analytic_tag">
                            <t t-foreach="doc.invoice_line_ids.sorted(key=lambda x: (x.name, x.package_id.shipping_grade == 'fresh', x.shipping_quantity_r == 0), reverse=True)" t-as="line">

                              <t t-set="uniq_analytic_tag" t-value="0"/>
                              <t t-set="uniq_analytic_tag_count" t-value="0"/>
                                <t t-foreach="line.analytic_tag_ids.sorted(key=lambda a: (a.sequence), reverse=False)" t-as="a_tag">
                                  <t t-if="uniq_analytic_tag_count==1">
                                    <t t-set="uniq_analytic_tag" t-value="a_tag.name"/>
                                  </t>
                                  <t t-set="uniq_analytic_tag_count" t-value="uniq_analytic_tag_count + 1"/>
                                </t>
                                <t t-if="uniq_analytic_tag_count==1">
                                  <t t-set="uniq_analytic_tag_count" t-value="0"/>
                                  <t t-foreach="line.analytic_tag_ids.sorted(key=lambda a: (a.sequence), reverse=False)" t-as="b_tag">
                                    <t t-if="uniq_analytic_tag_count==0">
                                      <t t-set="uniq_analytic_tag" t-value="b_tag.name"/>
                                    </t>
                                    <t t-set="uniq_analytic_tag_count" t-value="uniq_analytic_tag_count + 1"/>
                                  </t>
                                </t>
                                <t t-if="analytic_tag.name==uniq_analytic_tag">
                                <t t-set="sum_qty_line" t-value="0"/>
                                <t t-set="diff_packing_type" t-value=""/>
                                <t t-set="sam_packing_type_product" t-value=""/>
                                <t t-set="diff_packing_type_product" t-value=""/>
                                <t t-set="sum_packing_qty_line" t-value="0"/>
                                <t t-set="sum_diff_packing_qty_line" t-value="0"/>
                                <t t-set="sam_packing_type" t-value=""/>
                                <t t-set="diff_packing_type" t-value=""/>
                                <t t-set="sum_price_subtotal" t-value="0"/>
                                <t t-if="line.product_id and line.package_id.shipping_grade == 'fresh'" t-set="sum_fresh_qty" t-value="sum_fresh_qty + line.quantity"/>
                                <t t-if="line.product_id and line.package_id.shipping_grade == 'b'" t-set="sum_bgrade_qty" t-value="sum_bgrade_qty + line.quantity"/>
                                <t t-if="line.product_id and line.package_id.shipping_grade == 'c'" t-set="sum_cgrade_qty" t-value="sum_cgrade_qty + line.quantity"/>
                                <t t-set="sum_tot_invoice_qty" t-value="sum_fresh_qty + sum_bgrade_qty + sum_cgrade_qty"/>
                                <t t-if="not sum_fresh_qty and not sum_bgrade_qty and not sum_cgrade_qty" t-set="sum_tot_invoice_qty" t-value="sum_tot_invoice_qty + line.quantity"/>
                                <t t-foreach="doc.invoice_line_ids.sorted(key=lambda x: (x.package_id.shipping_grade == 'fresh', x.shipping_quantity_r == 0, x.name), reverse=True)" t-as="l">
                                  <t t-if="l.package_id.packing_type != line.package_id.packing_type">
                                    <t t-set="diff_packing_type" t-value="l.package_id.packing_type"/>
                                  </t>
                                  <t t-if="line.name == l.name and line.package_id.packing_type == l.package_id.packing_type">
                                    <t t-set="sum_packing_qty_line" t-value="sum_packing_qty_line + l.package_id.packing_quantity"/>
                                    <t t-set="sum_qty_line" t-value="sum_qty_line + l.quantity"/>
                                    <t t-set="sum_price_subtotal" t-value="sum_price_subtotal + l.price_subtotal"/>
                                  </t>
                                </t>
                                <t t-if="(not line.name in sum_product_name) or (not line.package_id.packing_type == same_packing_type)">
                                <tr>
                                  <t t-set="table_index" t-value="table_index + 1"/>
                                  <td style="width:37%; padding:4px; text-align: left; border-right: 1px solid black; font-size:14.5px;">
                                    <t t-set="p_name" t-value="line.name"/>
                                    <t t-set="p_name" t-value="p_name.replace(' ' , ',')"/>
                                    <t t-set="pr_name" t-value="p_name.split(',')"/>
                                    <t t-set="count" t-value="0"/>
                                    <t t-foreach="pr_name" t-as="p">
                                      <t t-set="count" t-value="count+1"/>
                                    </t>
                                    <span t-if="line.package_id.shipping_grade == 'fresh'" t-esc="sum_packing_qty_line" t-options="{&quot;widget&quot;: &quot;float&quot;, &quot;precision&quot;: 0}"/><span t-if="line.package_id.shipping_grade == 'fresh' and line.package_id.packing_type == 'thaan'" style="margin-left:3px;">Pcs</span><span t-if="line.package_id.shipping_grade == 'fresh' and not line.package_id.packing_type == 'thaan'" t-field="line.package_id.packing_type" style="margin-left:3px;"/> 
                                    <t t-if="pr_name and line.package_id.shipping_grade == 'fresh'">
                                      <span t-if="pr_name" t-esc="pr_name[0]"/> 
                                      <span t-if="count &gt; 1" t-esc="pr_name[1]"/> 
                                      <span t-if="count &gt; 1 and line.package_id.shipping_grade == 'fresh'" t-esc="pr_name[2]"/> 
                                      <t t-foreach="line.analytic_tag_ids.sorted(key=lambda a: (a.sequence), reverse=False)" t-as="tag">
                                        <span t-esc="tag.name"/>
                                      </t>
                                      </t>
                                      <span t-if="not line.name == 'Cut Piece' and not line.name == 'B-Grade'" t-field="line.product_id.product_template_attribute_value_ids.name"/>

                                    <span t-if="not line.product_id or line.name == 'B-Grade' or line.name == 'Cut Piece'" t-esc="line.name"/>
                                    </td>
                                  <td style="width:10%; padding:4px; text-align: right; border-right: 1px solid black;">
                                    <span t-esc="sum_qty_line" t-options="{&quot;widget&quot;: &quot;float&quot;, &quot;precision&quot;: 2}"/>
                                  </td>
                                  <td style="width:10%; padding:4px; text-align: right; border-right: 1px solid black;">
                                    <span t-esc="'{0:,.3f}'.format(line.price_unit)"/>
                                    </td>
                                  <td style="width:10%; padding:4px; text-align: right; border-right: 1px solid black;"><span t-esc="'{0:,.2f}'.format(int(sum_price_subtotal))"/></td>
                                </tr>
                                </t>
                                <t t-set="same_packing_type" t-value="line.package_id.packing_type"/>
                                <t t-set="sum_product_name" t-value="line.name"/>

                          </t>
                          </t>
                          </t>

                          <t t-foreach="doc.invoice_line_ids.sorted(key=lambda x: (x.package_id.shipping_grade == 'fresh', x.shipping_quantity_r == 0, x.name in 'Charges', x.name == 'B-Grade'), reverse=True)" t-as="line">
                          <t t-if="'Charges' in line.name or line.name == 'B-Grade' or line.name == 'Cut Piece'">
                                <t t-set="sum_qty_line" t-value="0"/>
                                <t t-set="diff_packing_type" t-value=""/>
                                <t t-set="sam_packing_type_product" t-value=""/>
                                <t t-set="diff_packing_type_product" t-value=""/>
                                <t t-set="sum_packing_qty_line" t-value="0"/>
                                <t t-set="sum_diff_packing_qty_line" t-value="0"/>
                                <t t-set="sam_packing_type" t-value=""/>
                                <t t-set="diff_packing_type" t-value=""/>
                                <t t-set="sum_price_subtotal" t-value="0"/>
                                <t t-if="line.product_id and line.package_id.shipping_grade == 'fresh'" t-set="sum_fresh_qty" t-value="sum_fresh_qty + line.quantity"/>
                                <t t-if="line.product_id and line.package_id.shipping_grade == 'b'" t-set="sum_bgrade_qty" t-value="sum_bgrade_qty + line.quantity"/>
                                <t t-if="line.product_id and line.package_id.shipping_grade == 'c'" t-set="sum_cgrade_qty" t-value="sum_cgrade_qty + line.quantity"/>
                                <t t-set="sum_tot_invoice_qty" t-value="sum_fresh_qty + sum_bgrade_qty + sum_cgrade_qty"/>
                                <t t-if="not sum_fresh_qty and not sum_bgrade_qty and not sum_cgrade_qty" t-set="sum_tot_invoice_qty" t-value="sum_tot_invoice_qty + line.quantity"/>
                                <t t-foreach="doc.invoice_line_ids.sorted(key=lambda x: (x.package_id.shipping_grade == 'fresh', x.shipping_quantity_r == 0, x.name == 'B-Grade'), reverse=True)" t-as="l">
                                  <t t-if="l.package_id.packing_type != line.package_id.packing_type">
                                    <t t-set="diff_packing_type" t-value="l.package_id.packing_type"/>
                                  </t>
                                  <t t-if="line.name == l.name and line.package_id.packing_type == l.package_id.packing_type">
                                    <t t-set="sum_packing_qty_line" t-value="sum_packing_qty_line + l.package_id.packing_quantity"/>
                                    <t t-set="sum_qty_line" t-value="sum_qty_line + l.quantity"/>
                                    <t t-set="sum_price_subtotal" t-value="sum_price_subtotal + l.price_subtotal"/>
                                  </t>
                                </t>
                                <t t-if="(not line.name == sum_product_name) or (not line.package_id.packing_type == same_packing_type)">
                                <tr>
                                  <t t-set="table_index" t-value="table_index + 1"/>
                                  <td style="width:37%; padding:4px; text-align: left; border-right: 1px solid black; font-size:14.5px;">
                                    <t t-set="p_name" t-value="line.name"/>
                                    <t t-set="p_name" t-value="p_name.replace(' ' , ',')"/>
                                    <t t-set="pr_name" t-value="p_name.split(',')"/>
                                    <t t-set="count" t-value="0"/>
                                    <t t-foreach="pr_name" t-as="p">
                                      <t t-set="count" t-value="count+1"/>
                                    </t>
                                    <span t-if="line.package_id.shipping_grade == 'fresh'" t-esc="sum_packing_qty_line" t-options="{&quot;widget&quot;: &quot;float&quot;, &quot;precision&quot;: 0}"/><span t-if="line.package_id.shipping_grade == 'fresh' and line.package_id.packing_type == 'thaan'" style="margin-left:3px;">Pcs</span><span t-if="line.package_id.shipping_grade == 'fresh' and not line.package_id.packing_type == 'thaan'" t-field="line.package_id.packing_type" style="margin-left:3px;"/> 
                                    <t t-if="pr_name and line.package_id.shipping_grade == 'fresh'">
                                      <span t-if="pr_name" t-esc="pr_name[0]"/> 
                                      <span t-if="count &gt; 1" t-esc="pr_name[1]"/> 
                                      <span t-if="count &gt; 1 and line.package_id.shipping_grade == 'fresh'" t-esc="pr_name[2]"/> 
                                      <t t-foreach="line.analytic_tag_ids.sorted(key=lambda a: (a.sequence), reverse=False)" t-as="tag">
                                        <span t-esc="tag.name"/>
                                      </t>
                                      </t>
                                      <span t-if="not line.name == 'Cut Piece' and not line.name == 'B-Grade'" t-field="line.product_id.product_template_attribute_value_ids.name"/>

                                    <!--</t>-->
                                    <span t-if="not line.product_id or line.name == 'B-Grade' or line.name == 'Cut Piece'" t-esc="line.name"/>
                                    </td>
                                  <td style="width:10%; padding:4px; text-align: right; border-right: 1px solid black;">
                                    <span t-esc="sum_qty_line" t-options="{&quot;widget&quot;: &quot;float&quot;, &quot;precision&quot;: 2}"/>
                                  </td>
                                  <td style="width:10%; padding:4px; text-align: right; border-right: 1px solid black;">
                                    <span t-esc="'{0:,.3f}'.format(line.price_unit)"/>
                                  </td>
                                  <td style="width:10%; padding:4px; text-align: right; border-right: 1px solid black;"><span t-esc="'{0:,.2f}'.format(int(sum_price_subtotal))"/></td>
                                </tr>
                                </t>
                                <t t-set="same_packing_type" t-value="line.package_id.packing_type"/>
                                <t t-set="sum_product_name" t-value="line.name"/>

                          </t>
                         </t>
                        </tbody>
                      </table>
                    </div>
                    <div class="row">
                      <div class="col-8" style="margin-left:-12px;">
                        <br/>
                        <table style="width:100%; margin-top:-15px;">
                          <tbody>
                            <tr>
                              <td style="width:25%;"><strong>Total Fresh:</strong></td>
                              <td style="text-align: right;">
                                <t t-esc="sum_fresh_qty" t-options="{&quot;widget&quot;: &quot;float&quot;, &quot;precision&quot;: 2}"/>
                                <span>mtr</span></td>
                            </tr>
                          </tbody>

                        </table>
                        <table style="width:100%; margin-top:5px;">
                          <tbody>
                            <tr>
                              <td style="width:25%;"><strong>Total B-Grade:</strong></td>
                              <td style="text-align: right;">
                                <t t-esc="sum_bgrade_qty" t-options="{&quot;widget&quot;: &quot;float&quot;, &quot;precision&quot;: 2}"/>
                                <span>mtr</span></td>
                            </tr>
                          </tbody>

                        </table>
                        <table style="width:100%; margin-top:5px;">
                          <tbody>
                            <tr>
                              <td style="width:25%;"><strong>Total C-Grade:</strong></td>
                              <td style="text-align: right;">
                                <t t-esc="sum_cgrade_qty" t-options="{&quot;widget&quot;: &quot;float&quot;, &quot;precision&quot;: 2}"/>
                                <span>mtr</span></td>
                            </tr>
                          </tbody>

                        </table>
                        <table style="width:100%; margin-top:5px;">
                          <tbody>
                            <tr style="border-top:1px solid black;">
                              <td style="width:25%;"><strong>Total Quantity:</strong></td>
                              <td style="text-align: right;">
                                <t t-esc="sum_tot_invoice_qty" t-options="{&quot;widget&quot;: &quot;float&quot;, &quot;precision&quot;: 2}"/>
                                <span>mtr</span></td>
                            </tr>
                          </tbody>

                        </table>

                        <t t-set="sum_produced_qty" t-value="0"/>
                        <t t-set="sum_rec_qty" t-value="0"/>
                        <t t-set="rem_qty" t-value="0"/>
                        <t t-foreach="request.env['mrp.production'].search([('product_id.categ_id','=', 237),('sale_id','=', doc.invoice_origin)])" t-as="production_order">
                          <t t-foreach="production_order.finished_move_line_ids" t-as="production_line">
                            <t t-set="sum_produced_qty" t-value="sum_produced_qty + production_line.qty_done"/>
                          </t>
                        </t>
                        <t t-foreach="request.env['stock.picking'].search([('sale_tag','=', doc.invoice_origin),('move_line_ids.lot_id.cloth_desc','=', doc.invoice_origin)])" t-as="picking_ref">
                          <t t-foreach="picking_ref.move_line_ids" t-as="move_line">
                              <t t-set="sum_rec_qty" t-value="sum_rec_qty + move_line.qty_done"/>
                          </t>
                        </t>
                        <t t-set="rem_qty" t-value="rem_qty + sum_rec_qty - sum_produced_qty"/>
                        <!--Greige Details Section Start-->

                        <table style="width:100%; margin-top:10px;">
                          <tbody>
                            <tr>
                              <td style="width:25%;"><strong>Amount in Words:</strong></td>
                              <td><t t-esc="doc.amt_words"/></td>
                            </tr>
                          </tbody>


                        </table>
                          <!--Greige Details Section End-->
                      </div>
                      <div class="col-4" style="float:left; position:relative; border-left: 2px solid black; border-right: 2px solid black; border-bottom: 2px solid black; margin-left: 14px;">
                                <table class="" style="margin-top:-15px;">
                                    <tr class="o_subtotal" style="border-bottom: 1px solid #d9d9d4;">
                                        <td style="padding:3px;"><strong>Subtotal</strong></td>
                                        <td class="text-right" style="padding:3px;">
                                            <span t-field="doc.amount_untaxed"/>
                                        </td>
                                    </tr>
                                    <t t-foreach="doc.amount_by_group" t-as="amount_by_group">
                                        <tr style="border-bottom: 1px solid #d9d9d4;">
                                            <t t-if="len(doc.invoice_line_ids.tax_ids) == 1 and doc.amount_untaxed == amount_by_group[2]">
                                                <td style="padding:3px;"><span t-esc="amount_by_group[0]"/></td>
                                                <td class="text-right o_price_total" style="padding:3px;">
                                                    <span t-esc="amount_by_group[3]"/>
                                                </td>
                                            </t>
                                            <t t-else="">
                                                <td style="padding:3px;">
                                                    <span t-esc="amount_by_group[0]"/>
                                                    <span>&amp;nbsp;<span>on</span>
                                                        <t t-esc="amount_by_group[4]"/>
                                                    </span>
                                                </td>
                                                <td class="text-right o_price_total" style="padding:3px;">
                                                    <span t-esc="amount_by_group[3]"/>
                                                </td>
                                            </t>
                                        </tr>
                                    </t>
                                    <br/>
                                    <tr class="" style="margin-top:0px;">
                                        <td style="padding:3px;"><strong>Total</strong></td>
                                        <td class="text-right" style="padding:3px;">
                                            <span t-field="doc.amount_total"/>
                                        </td>
                                    </tr>
                                </table>
                        </div>
                        </div>
                      <div class="row" style="margin-top:10px;">
                          <div class="col-8" style="margin-left:-12px; margin-top:5px;">
                            <strong>Greige Details:</strong>
                            <table style="width:100%;">
                              <tr>
                                <td>
                                  <td style="width:25%;"><strong>Total Greige Used:</strong></td>
                                  <td><span>______________________ </span><span>mtr</span></td>
                                </td>
                              </tr>
                            </table>
                          </div>
                        </div>
                    <!--Page Break Always if Table row greatr than 17-->
                    <!--<div t-if="table_index &gt; 18" style="page-break-before:always;"/>-->
                    <!--End Page break-->
                       <!--Greige Details and SubTotal/Total Section End -->
                    <!--Check/Approved Signature Section Start-->
                    <div class="row" style="margin-top:60px;">
                      <div style="margin-top:10px;">
                        <div style="float:left; margin-left:10px;">
                          <span t-field="doc.create_uid.name" style="text-decoration: underline;"/>
                          <br/>
                          <div class="text-center" style="font-size: 11pt;font-family:Helvetica,Verdana,Arial,sans,Lucida Grande,Calibri;"><strong>Prepared By:</strong></div>

                        </div>
                        <div style="float:left; margin-left: 25px;">
                  			______________________
                  			<br/>
                   	<div class="text-center" style="font-size: 11pt;font-family:Helvetica,Verdana,Arial,sans,Lucida Grande,Calibri;"><strong>Checked By:</strong></div>
                   	</div>
                   	<div style="float:left; margin-left: 25px;">
                  			______________________
                  			<br/>
                   	<div class="text-center" style="font-size: 11pt;font-family:Helvetica,Verdana,Arial,sans,Lucida Grande,Calibri;"><strong>Verified By:</strong></div>
                   	</div>
                   	<div style="float:left; margin-left: 25px;">
                  			______________________
                  			<br/>
                   	<div class="text-center" style="font-size: 11pt;font-family:Helvetica,Verdana,Arial,sans,Lucida Grande,Calibri;"><strong>Approved By:</strong></div>
                   	</div>

                      </div>
                    </div>
                    <!--Check/Approved Signature Section End-->
                    <!--Note Section Start-->
                    <div class="row" style="margin-top:30px;">
                      <div class="col-12">
                        <strong style="font-size:12px;">Note:</strong>
                        <br/>
                        <p style="font-size:11px;">We are only responsible for any deficiency in your Finish Fabric regarding Fresh &amp; B.C.P percentage &amp; also any other claim/problem untill the fabric laying in our premisis. Please take over your BCP meters wihtin maximum 1 month from the bill date. After that we are not responsible of your BCP meters.</p>
                      </div>
                    </div>
                    <!--Note Section End-->
                </div>
            </t>
        </t>
        </t>
    </template>
</odoo>